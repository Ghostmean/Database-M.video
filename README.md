**–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –ø–æ –ë–î**

–ü–µ—Ä–µ—á–µ–Ω—å [–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã](https://edu.irnok.net/lib/exe/fetch.php?media=db:%D0%B2%D0%B0%D1%80%D0%B8%D0%B0%D0%BD%D1%82%D1%8B_%D0%B7%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D0%B9_%D0%BF%D0%BE_%D1%83%D0%B4.pdf)

Telegram: [@your_username]

# –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏ (–í–∞—à –≤–∞—Ä–∏–∞–Ω—Ç)

**–ú–∞–≥–∞–∑–∏–Ω —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏ (–ø–æ–¥–æ–±–Ω—ã–π M.Video)**

*–°—É—â–Ω–æ—Å—Ç–∏:* –ö–ª–∏–µ–Ω—Ç—ã (ID, –§–ò–û, –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ), –¢–æ–≤–∞—Ä—ã (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ), –ó–∞–∫–∞–∑—ã (–Ω–æ–º–µ—Ä, –¥–∞—Ç–∞, —Å—Ç–∞—Ç—É—Å), –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞ (—Ç–æ–≤–∞—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Ü–µ–Ω–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–æ–∫—É–ø–∫–∏).

*–ü—Ä–æ—Ü–µ—Å—Å—ã:* –ö–ª–∏–µ–Ω—Ç—ã –æ—Ñ–æ—Ä–º–ª—è—é—Ç –∑–∞–∫–∞–∑—ã –Ω–∞ —Ç–æ–≤–∞—Ä—ã. –í –∑–∞–∫–∞–∑ –º–æ–∂–µ—Ç –≤—Ö–æ–¥–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ä–∞–∑–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ. –§–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ (–ù–æ–≤—ã–π, –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –û—Ç–ø—Ä–∞–≤–ª–µ–Ω, –î–æ—Å—Ç–∞–≤–ª–µ–Ω, –û—Ç–º–µ–Ω–µ–Ω) –∏ —Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–æ–∫—É–ø–∫–∏.

*–í—ã—Ö–æ–¥–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:*
  - –î–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ —Å –æ–±—â–µ–π —Å—É–º–º–æ–π –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –¥–∞—Ç–µ (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ).
  - –í—ã–¥–∞—Ç—å —Ç–æ–ø-5 —Å–∞–º—ã—Ö –ø—Ä–æ–¥–∞–≤–∞–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü (–ø–æ —É–±—ã–≤–∞–Ω–∏—é).

# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 1 (–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–π –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏ –ë–î)

## ER-–¥–∏–∞–≥—Ä–∞–º–º–∞

```mermaid
erDiagram
    CLIENTS ||--o{ ORDERS : "places"
    ORDERS ||--|{ ORDER_ITEMS : "contains"
    ORDER_ITEMS }o--|| PRODUCTS : "refers_to"

    CLIENTS {
        integer client_id PK "SERIAL"
        varchar first_name
        varchar last_name
        varchar email
        varchar phone
        date registration_date
    }

    PRODUCTS {
        integer product_id PK "SERIAL"
        varchar product_name
        text description
        numeric price
        integer stock_quantity
    }

    ORDERS {
        integer order_id PK "SERIAL"
        integer client_id FK
        timestamp order_date
        varchar status
    }

    ORDER_ITEMS {
        integer order_id PK,FK
        integer product_id PK,FK
        integer quantity
        numeric price_at_time
    }
```


–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º
–ü–µ—Ä–≤–∞—è –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ (1NF): –°–æ–±–ª—é–¥–µ–Ω–∞. –í—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã –∞—Ç–æ–º–∞—Ä–Ω—ã, —Å—Ç—Ä–æ–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–µ—Ä–≤–∏—á–Ω—ã–µ –∫–ª—é—á–∏.

–í—Ç–æ—Ä–∞—è –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ (2NF): –°–æ–±–ª—é–¥–µ–Ω–∞. –í—Å–µ –Ω–µ–∫–ª—é—á–µ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤—Å–µ–≥–æ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞. –í —Ç–∞–±–ª–∏—Ü–µ order_items –ø–æ–ª—è quantity –∏ price_at_time –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (order_id, product_id).

–¢—Ä–µ—Ç—å—è –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ (3NF): –°–æ–±–ª—é–¥–µ–Ω–∞. –¢—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –ù–∞–ø—Ä–∏–º–µ—Ä, —Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ price_at_time –≤ order_items —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫–∞–∑–∞ –∏ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥—Ä—É–≥–∏—Ö –Ω–µ–∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π.

–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 2 (–°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü)
–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü

```sql
-- 1. –¢–∞–±–ª–∏—Ü–∞ 'clients' (–ö–ª–∏–µ–Ω—Ç—ã)
CREATE TABLE zyryanov_2271.clients (
    client_id SERIAL PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(20) NULL,
    registration_date DATE NOT NULL DEFAULT CURRENT_DATE
);

-- 2. –¢–∞–±–ª–∏—Ü–∞ 'products' (–¢–æ–≤–∞—Ä—ã)
CREATE TABLE zyryanov_2271.products (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(100) NOT NULL,
    description TEXT NULL,
    price NUMERIC(10, 2) NOT NULL CHECK (price >= 0),
    stock_quantity INTEGER NOT NULL DEFAULT 0 CHECK (stock_quantity >= 0)
);

-- 3. –¢–∞–±–ª–∏—Ü–∞ 'orders' (–ó–∞–∫–∞–∑—ã)
CREATE TABLE zyryanov_2271.orders (
    order_id SERIAL PRIMARY KEY,
    client_id INTEGER NOT NULL REFERENCES zyryanov_2271.clients(client_id),
    order_date TIMESTAMP NOT NULL DEFAULT NOW(),
    status VARCHAR(20) NOT NULL DEFAULT '–ù–æ–≤—ã–π' CHECK (status IN ('–ù–æ–≤—ã–π', '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω', '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω', '–î–æ—Å—Ç–∞–≤–ª–µ–Ω', '–û—Ç–º–µ–Ω–µ–Ω'))
);

-- 4. –¢–∞–±–ª–∏—Ü–∞ 'order_items' (–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞)
CREATE TABLE zyryanov_2271.order_items (
    order_id INTEGER NOT NULL REFERENCES zyryanov_2271.orders(order_id),
    product_id INTEGER NOT NULL REFERENCES zyryanov_2271.products(product_id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    price_at_time NUMERIC(10, 2) NOT NULL CHECK (price_at_time >= 0),
    PRIMARY KEY (order_id, product_id)
);
```

```sql
-- –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É 'clients'
INSERT INTO zyryanov_2271.clients (first_name, last_name, email, phone) VALUES
('–ò–≤–∞–Ω', '–ü–µ—Ç—Ä–æ–≤', 'petrov@mail.com', '+7(900)123-45-67'),
('–ú–∞—Ä–∏—è', '–°–∏–¥–æ—Ä–æ–≤–∞', 'sidorova.m@mail.com', '+7(900)765-43-21'),
('–ê–ª–µ–∫—Å–µ–π', '–ö—É–∑–Ω–µ—Ü–æ–≤', 'kuznetsov.a@yandex.ru', NULL),
('–ï–ª–µ–Ω–∞', '–°–º–∏—Ä–Ω–æ–≤–∞', 'smirnova.e@mail.com', '+7(901)111-22-33');

-- –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É 'products'
INSERT INTO zyryanov_2271.products (product_name, description, price, stock_quantity) VALUES
('–°–º–∞—Ä—Ç—Ñ–æ–Ω XYZ', '–ú–æ—â–Ω—ã–π —Ñ–ª–∞–≥–º–∞–Ω —Å –ª—É—á—à–µ–π –∫–∞–º–µ—Ä–æ–π', 89999.99, 15),
('–ù–æ—É—Ç–±—É–∫ Ultrabook', '–õ–µ–≥–∫–∏–π –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π, 13 –¥—é–π–º–æ–≤', 124999.50, 8),
('–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–µ –Ω–∞—É—à–Ω–∏–∫–∏', '–° —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ–º, –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã 20—á', 19999.00, 30),
('–ö–æ–≤—Ä–∏–∫ –¥–ª—è –º—ã—à–∏', '–ë–æ–ª—å—à–æ–π, –∏–≥—Ä–æ–≤–æ–π, —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π', 1500.00, 100);

-- –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É 'orders'
INSERT INTO zyryanov_2271.orders (client_id, status) VALUES
(1, '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω'),
(2, '–ù–æ–≤—ã–π'),
(3, '–î–æ—Å—Ç–∞–≤–ª–µ–Ω'),
(1, '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω');

-- –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É 'order_items'
INSERT INTO zyryanov_2271.order_items (order_id, product_id, quantity, price_at_time) VALUES
(1, 1, 1, 89999.99),
(1, 3, 1, 19999.00),
(2, 2, 1, 124999.50),
(3, 4, 2, 1500.00),
(4, 1, 1, 87999.99);
```
```sql
SELECT 
    c.first_name,
    c.last_name,
    o.order_id,
    o.order_date,
    o.status,
    p.product_name,
    oi.quantity,
    oi.price_at_time,
    (oi.quantity * oi.price_at_time) AS total_sum
FROM zyryanov_2271.orders o
JOIN zyryanov_2271.clients c ON o.client_id = c.client_id
JOIN zyryanov_2271.order_items oi ON o.order_id = oi.order_id
JOIN zyryanov_2271.products p ON oi.product_id = p.product_id
ORDER BY o.order_id;
```

# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 3. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
## –¶–µ–ª—å: –û—Å–≤–æ–µ–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π.

## üìã –ó–∞–¥–∞—á–∏:

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ö—Ä–∞–Ω–∏–º—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
### –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –ø–æ–º–æ—â–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

### 1.–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```sql
CREATE OR REPLACE VIEW zyryanov_2271.active_clients_report
 AS
 SELECT clients.client_id,
    (clients.first_name::text || ' '::text) || clients.last_name::text AS full_name,
    clients.email,
    clients.registration_date
   FROM zyryanov_2271.clients
  WHERE clients.registration_date >= (CURRENT_DATE - '1 year'::interval)
  ORDER BY clients.registration_date DESC;

ALTER TABLE zyryanov_2271.active_clients_report
    OWNER TO student;


```

```sql
CREATE OR REPLACE VIEW zyryanov_2271.monthly_orders_report
 AS
 SELECT o.order_id,
    (c.first_name::text || ' '::text) || c.last_name::text AS client_name,
    o.order_date,
    o.status,
    count(oi.product_id) AS items_count,
    sum(oi.quantity::numeric * oi.price_at_time) AS order_total
   FROM zyryanov_2271.orders o
     JOIN zyryanov_2271.clients c ON o.client_id = c.client_id
     JOIN zyryanov_2271.order_items oi ON o.order_id = oi.order_id
  WHERE o.order_date >= date_trunc('month'::text, CURRENT_DATE::timestamp with time zone)
  GROUP BY o.order_id, c.first_name, c.last_name, o.order_date, o.status
  ORDER BY o.order_date DESC;

ALTER TABLE zyryanov_2271.monthly_orders_report
    OWNER TO student;

```

```sql
CREATE OR REPLACE VIEW zyryanov_2271.products_stock_report
 AS
 SELECT products.product_id,
    products.product_name,
    products.price,
    products.stock_quantity,
        CASE
            WHEN products.stock_quantity = 0 THEN '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'::text
            WHEN products.stock_quantity < 10 THEN '–ú–∞–ª–æ'::text
            ELSE '–í –Ω–∞–ª–∏—á–∏–∏'::text
        END AS stock_status
   FROM zyryanov_2271.products
  ORDER BY products.stock_quantity DESC, products.price DESC;

ALTER TABLE zyryanov_2271.products_stock_report
    OWNER TO student;
```
### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä 
```sql
CREATE OR REPLACE PROCEDURE zyryanov_2271.get_active_clients_report(
    OUT p_total_count bigint,
    IN p_years_back integer DEFAULT 1,
    IN p_min_date date DEFAULT NULL,
    IN p_max_date date DEFAULT NULL,
    IN p_email_pattern text DEFAULT NULL,
    IN p_sort_column text DEFAULT 'registration_date',
    IN p_sort_direction text DEFAULT 'DESC',
    IN p_limit_records integer DEFAULT NULL,
    IN p_offset_records integer DEFAULT 0
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_sql text;
    v_where_conditions text := '';
    v_sort_direction text;
    v_sort_column text;
BEGIN
    -- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    v_sort_direction := CASE 
        WHEN UPPER(p_sort_direction) = 'ASC' THEN 'ASC'
        ELSE 'DESC'
    END;
    
    -- –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    v_sort_column := CASE 
        WHEN p_sort_column IN ('client_id', 'full_name', 'email', 'registration_date') 
        THEN p_sort_column
        ELSE 'registration_date'
    END;
    
    -- –ë–∞–∑–æ–≤–æ–µ —É—Å–ª–æ–≤–∏–µ
    v_where_conditions := format(
        'registration_date >= CURRENT_DATE - INTERVAL ''%s year''',
        p_years_back
    );
    
    -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    IF p_min_date IS NOT NULL THEN
        v_where_conditions := v_where_conditions || 
            format(' AND registration_date >= ''%s''', p_min_date);
    END IF;
    
    IF p_max_date IS NOT NULL THEN
        v_where_conditions := v_where_conditions || 
            format(' AND registration_date <= ''%s''', p_max_date);
    END IF;
    
    IF p_email_pattern IS NOT NULL THEN
        v_where_conditions := v_where_conditions || 
            format(' AND email ILIKE ''%%%s%%''', p_email_pattern);
    END IF;
    
    -- –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    EXECUTE format(
        'SELECT COUNT(*) FROM zyryanov_2271.active_clients_report WHERE %s',
        v_where_conditions
    ) INTO p_total_count;
    
    -- –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    CREATE TEMP TABLE temp_active_clients ON COMMIT DROP AS
    SELECT * FROM zyryanov_2271.active_clients_report
    WHERE registration_date >= CURRENT_DATE - INTERVAL '1 year' * p_years_back
        AND (p_min_date IS NULL OR registration_date >= p_min_date)
        AND (p_max_date IS NULL OR registration_date <= p_max_date)
        AND (p_email_pattern IS NULL OR email ILIKE '%' || p_email_pattern || '%');
    
    -- –í–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    -- –ö–ª–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤ —Å–µ—Å—Å–∏–∏ –∫–∞–∫ temp_active_clients
    RAISE NOTICE '–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ temp_active_clients';
    RAISE NOTICE '–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤: %', p_total_count;
END;
$$;

ALTER PROCEDURE zyryanov_2271.get_active_clients_report(
    bigint, integer, date, date, text, text, text, integer, integer
) OWNER TO student;
```
```sql
CREATE OR REPLACE PROCEDURE zyryanov_2271.get_orders_analysis(
    OUT p_orders_cursor refcursor,
    OUT p_summary_json jsonb,
    OUT p_total_orders bigint,
    OUT p_total_revenue numeric,
    OUT p_avg_order_value numeric,
    IN p_start_date date DEFAULT NULL,
    IN p_end_date date DEFAULT NULL,
    IN p_status_list text[] DEFAULT NULL,
    IN p_min_items integer DEFAULT NULL,
    IN p_min_total numeric DEFAULT NULL,
    IN p_max_total numeric DEFAULT NULL
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_min_date date;
    v_max_date date;
BEGIN
    -- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    IF p_start_date IS NULL THEN
        v_min_date := date_trunc('month', CURRENT_DATE);
    ELSE
        v_min_date := p_start_date;
    END IF;
    
    IF p_end_date IS NULL THEN
        v_max_date := v_min_date + INTERVAL '1 month' - INTERVAL '1 day';
    ELSE
        v_max_date := p_end_date;
    END IF;
    
    -- –û—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫–∞–∑–æ–≤
    OPEN p_orders_cursor FOR
    SELECT 
        order_id,
        client_name,
        order_date,
        status,
        items_count,
        order_total,
        CASE 
            WHEN order_total > 5000 THEN '–ö–†–£–ü–ù–´–ô'
            WHEN order_total > 1000 THEN '–°–†–ï–î–ù–ò–ô'
            ELSE '–ú–ê–õ–´–ô'
        END as order_size_category
    FROM zyryanov_2271.monthly_orders_report
    WHERE 
        order_date BETWEEN v_min_date AND v_max_date
        AND (p_status_list IS NULL OR status = ANY(p_status_list))
        AND (p_min_items IS NULL OR items_count >= p_min_items)
        AND (p_min_total IS NULL OR order_total >= p_min_total)
        AND (p_max_total IS NULL OR order_total <= p_max_total)
    ORDER BY order_date DESC, order_total DESC;
    
    -- –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    SELECT 
        COUNT(*),
        COALESCE(SUM(order_total), 0),
        COALESCE(AVG(order_total), 0)
    INTO 
        p_total_orders,
        p_total_revenue,
        p_avg_order_value
    FROM zyryanov_2271.monthly_orders_report
    WHERE order_date BETWEEN v_min_date AND v_max_date
        AND (p_status_list IS NULL OR status = ANY(p_status_list))
        AND (p_min_items IS NULL OR items_count >= p_min_items)
        AND (p_min_total IS NULL OR order_total >= p_min_total)
        AND (p_max_total IS NULL OR order_total <= p_max_total);
    
    -- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ JSON-—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
    p_summary_json := jsonb_build_object(
        'period', jsonb_build_object(
            'start_date', v_min_date,
            'end_date', v_max_date
        ),
        'filters_applied', jsonb_build_object(
            'status_list', COALESCE(p_status_list, '{}'::text[]),
            'min_items', p_min_items,
            'min_total', p_min_total,
            'max_total', p_max_total
        ),
        'statistics', jsonb_build_object(
            'total_orders', p_total_orders,
            'total_revenue', ROUND(p_total_revenue, 2),
            'avg_order_value', ROUND(p_avg_order_value, 2)
        )
    );
    
    RAISE NOTICE '–ê–Ω–∞–ª–∏–∑ –∑–∞–∫–∞–∑–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—É—Ä—Å–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.';
END;
$$;

ALTER PROCEDURE zyryanov_2271.get_orders_analysis(
    refcursor, jsonb, bigint, numeric, numeric,
    date, date, text[], integer, numeric, numeric
) OWNER TO student;
```

```sql
CREATE OR REPLACE PROCEDURE zyryanov_2271.get_inventory_report(
    OUT p_report_cursor refcursor,
    OUT p_summary_stats jsonb,
    OUT p_total_products bigint,
    OUT p_low_stock_count bigint,
    OUT p_total_inventory_value numeric,
    IN p_stock_status text DEFAULT NULL,
    IN p_min_price numeric DEFAULT NULL,
    IN p_max_price numeric DEFAULT NULL,
    IN p_min_quantity integer DEFAULT NULL,
    IN p_max_quantity integer DEFAULT NULL,
    IN p_action text DEFAULT 'view',
    IN p_critical_threshold integer DEFAULT 10,
    IN p_excess_threshold integer DEFAULT 100
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_where_conditions text := '';
    v_sql_conditions text := '';
BEGIN
    -- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏–π WHERE –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç action
    CASE p_action
        WHEN 'critical' THEN
            v_where_conditions := 'stock_quantity < ' || p_critical_threshold;
        WHEN 'excess' THEN
            v_where_conditions := 'stock_quantity > ' || p_excess_threshold;
        ELSE
            v_where_conditions := '1=1';
    END CASE;
    
    -- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    IF p_stock_status IS NOT NULL THEN
        v_where_conditions := v_where_conditions || 
            ' AND stock_status = ''' || p_stock_status || '''';
    END IF;
    
    IF p_min_price IS NOT NULL THEN
        v_where_conditions := v_where_conditions || 
            ' AND price >= ' || p_min_price;
    END IF;
    
    IF p_max_price IS NOT NULL THEN
        v_where_conditions := v_where_conditions || 
            ' AND price <= ' || p_max_price;
    END IF;
    
    IF p_min_quantity IS NOT NULL THEN
        v_where_conditions := v_where_conditions || 
            ' AND stock_quantity >= ' || p_min_quantity;
    END IF;
    
    IF p_max_quantity IS NOT NULL THEN
        v_where_conditions := v_where_conditions || 
            ' AND stock_quantity <= ' || p_max_quantity;
    END IF;
    
    -- –û—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
    OPEN p_report_cursor FOR
    EXECUTE format(
        'SELECT * FROM zyryanov_2271.products_stock_report
         WHERE %s
         ORDER BY 
            CASE stock_status
                WHEN ''–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'' THEN 1
                WHEN ''–ú–∞–ª–æ'' THEN 2
                ELSE 3
            END,
            stock_quantity,
            price DESC',
        v_where_conditions
    );
    
    -- –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    EXECUTE format(
        'SELECT 
            COUNT(*),
            SUM(CASE WHEN stock_status IN (''–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'', ''–ú–∞–ª–æ'') THEN 1 ELSE 0 END),
            SUM(price * stock_quantity)
         FROM zyryanov_2271.products_stock_report
         WHERE %s',
        v_where_conditions
    ) INTO p_total_products, p_low_stock_count, p_total_inventory_value;
    
    -- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ JSON —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    p_summary_stats := jsonb_build_object(
        'inventory_summary', jsonb_build_object(
            'total_products', p_total_products,
            'low_stock_items', p_low_stock_count,
            'total_inventory_value', ROUND(COALESCE(p_total_inventory_value, 0), 2),
            'average_price', CASE 
                WHEN p_total_products > 0 
                THEN ROUND(COALESCE(p_total_inventory_value, 0) / NULLIF(p_total_products, 0), 2)
                ELSE 0 
            END
        ),
        'filters', jsonb_build_object(
            'stock_status', p_stock_status,
            'price_range', jsonb_build_object('min', p_min_price, 'max', p_max_price),
            'quantity_range', jsonb_build_object('min', p_min_quantity, 'max', p_max_quantity),
            'action', p_action
        )
    );
    
    RAISE NOTICE '–û—Ç—á–µ—Ç –ø–æ –∑–∞–ø–∞—Å–∞–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—É—Ä—Å–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.';
END;
$$;

ALTER PROCEDURE zyryanov_2271.get_inventory_report(
    refcursor, jsonb, bigint, bigint, numeric,
    text, numeric, numeric, integer, integer, text, integer, integer
) OWNER TO student;
```
### –ó–∞–ø—Ä–æ—Å—ã –∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è–º 

```sql
CALL zyryanov_2271.get_active_clients_report(NULL, 1, NULL, NULL, 'gmail.com', 'full_name', 'ASC', 50, 0);
SELECT * FROM temp_active_clients;

-- –í—Å–µ —Ç–æ–≤–∞—Ä—ã —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –Ω–∞–ª–∏—á–∏—é
SELECT *
FROM zyryanov_2271.products_stock_report
ORDER BY 
    CASE stock_status
        WHEN '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' THEN 1
        WHEN '–ú–∞–ª–æ' THEN 2
        ELSE 3
    END,
    stock_quantity;

-- –¢–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –∑–∞–ø–∞—Å–æ–º
SELECT *
FROM zyryanov_2271.products_stock_report
WHERE stock_status IN ('–ú–∞–ª–æ', '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏')
ORDER BY stock_quantity, price DESC;

-- –¢–æ–≤–∞—Ä—ã –ø–æ —Ü–µ–Ω–æ–≤—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
SELECT 
    CASE 
        WHEN price < 500 THEN '–≠–∫–æ–Ω–æ–º'
        WHEN price BETWEEN 500 AND 2000 THEN '–°—Ç–∞–Ω–¥–∞—Ä—Ç'
        WHEN price BETWEEN 2001 AND 5000 THEN '–ü—Ä–µ–º–∏—É–º'
        ELSE '–õ—é–∫—Å'
    END as price_category,
    COUNT(*) as product_count,
    SUM(stock_quantity) as total_stock,
    SUM(price * stock_quantity) as total_value
FROM zyryanov_2271.products_stock_report
GROUP BY 
    CASE 
        WHEN price < 500 THEN '–≠–∫–æ–Ω–æ–º'
        WHEN price BETWEEN 500 AND 2000 THEN '–°—Ç–∞–Ω–¥–∞—Ä—Ç'
        WHEN price BETWEEN 2001 AND 5000 THEN '–ü—Ä–µ–º–∏—É–º'
        ELSE '–õ—é–∫—Å'
    END
ORDER BY total_value DESC;

-- –¢–æ–≤–∞—Ä—ã —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–º–µ–Ω—å—à–µ 10 —à—Ç—É–∫)
SELECT *
FROM zyryanov_2271.products_stock_report
WHERE stock_quantity < 10
ORDER BY stock_quantity;

-- –°–∞–º—ã–µ –¥–æ—Ä–æ–≥–∏–µ —Ç–æ–≤–∞—Ä—ã –≤ –Ω–∞–ª–∏—á–∏–∏
SELECT *
FROM zyryanov_2271.products_stock_report
WHERE stock_status = '–í –Ω–∞–ª–∏—á–∏–∏'
ORDER BY price DESC
LIMIT 10;

-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–ø–∞—Å–∞–º
SELECT 
    stock_status,
    COUNT(*) as product_count,
    SUM(stock_quantity) as total_quantity,
    SUM(price * stock_quantity) as total_value,
    AVG(price) as avg_price
FROM zyryanov_2271.products_stock_report
GROUP BY stock_status
ORDER BY 
    CASE stock_status
        WHEN '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' THEN 1
        WHEN '–ú–∞–ª–æ' THEN 2
        ELSE 3
    END;
 ```


# 4 –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
## –¶–µ–ª—å: –û—Å–≤–æ–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ë–î.

üìã –ó–∞–¥–∞—á–∏:

### –°–æ–∑–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (20 000 –∑–∞–ø–∏—Å–µ–π –≤ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ)
### –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (EXPLAIN ANALYZE)
### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–æ/–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### –°–æ–∑–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (20 000 –∑–∞–ø–∏—Å–µ–π –≤ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ)
```sql
-- PROCEDURE: zyryanov_2271.generate_clients_data(integer)

-- DROP PROCEDURE IF EXISTS zyryanov_2271.generate_clients_data(integer);

CREATE OR REPLACE PROCEDURE zyryanov_2271.generate_clients_data(
	IN p_count integer DEFAULT 20000)
LANGUAGE 'plpgsql'
AS $BODY$
DECLARE
    i INTEGER;
    first_names TEXT[] := ARRAY['–ò–≤–∞–Ω', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ï–ª–µ–Ω–∞', '–î–º–∏—Ç—Ä–∏–π', '–û–ª—å–≥–∞', '–°–µ—Ä–≥–µ–π', '–ê–Ω–Ω–∞', '–ê–Ω–¥—Ä–µ–π', '–ù–∞—Ç–∞–ª—å—è'];
    last_names TEXT[] := ARRAY['–ò–≤–∞–Ω–æ–≤', '–ü–µ—Ç—Ä–æ–≤', '–°–∏–¥–æ—Ä–æ–≤', '–ö—É–∑–Ω–µ—Ü–æ–≤', '–°–º–∏—Ä–Ω–æ–≤', '–ü–æ–ø–æ–≤', '–í–∞—Å–∏–ª—å–µ–≤', '–ù–æ–≤–∏–∫–æ–≤', '–§–µ–¥–æ—Ä–æ–≤', '–ú–æ—Ä–æ–∑–æ–≤'];
    domains TEXT[] := ARRAY['mail.ru', 'gmail.com', 'yandex.ru', 'hotmail.com'];
BEGIN
    FOR i IN 1..p_count LOOP
        INSERT INTO zyryanov_2271.clients (
            first_name, 
            last_name, 
            email, 
            phone, 
            registration_date
        ) VALUES (
            first_names[1 + (i % array_length(first_names, 1))],
            last_names[1 + ((i + 2) % array_length(last_names, 1))],
            'client_' || (EXTRACT(EPOCH FROM NOW())::BIGINT + i) || '@' || domains[1 + (i % array_length(domains, 1))],
            CASE WHEN i % 10 != 0 THEN '+7(9' || LPAD((i % 1000000)::TEXT, 9, '0') ELSE NULL END,
            CURRENT_DATE - (RANDOM() * 365 * 2)::INTEGER
        );
        
        IF i % 5000 = 0 THEN
            RAISE NOTICE '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤: %', i;
        END IF;
    END LOOP;
END;
$BODY$;
ALTER PROCEDURE zyryanov_2271.generate_clients_data(integer)
    OWNER TO student;

```
```sql
-- PROCEDURE: zyryanov_2271.generate_products_data(integer)

-- DROP PROCEDURE IF EXISTS zyryanov_2271.generate_products_data(integer);

CREATE OR REPLACE PROCEDURE zyryanov_2271.generate_products_data(
	IN p_count integer DEFAULT 20000)
LANGUAGE 'plpgsql'
AS $BODY$
DECLARE
    i INTEGER;
    categories TEXT[] := ARRAY['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', '–û–¥–µ–∂–¥–∞', '–ö–Ω–∏–≥–∏', '–ú–µ–±–µ–ª—å', '–°–ø–æ—Ä—Ç', '–ö—Ä–∞—Å–æ—Ç–∞', '–ê–≤—Ç–æ', '–î–æ–º', '–ò–≥—Ä—É—à–∫–∏', '–ï–¥–∞'];
    products TEXT[] := ARRAY['–°–º–∞—Ä—Ç—Ñ–æ–Ω', '–ù–æ—É—Ç–±—É–∫', '–ü–ª–∞–Ω—à–µ—Ç', '–ù–∞—É—à–Ω–∏–∫–∏', '–¢–µ–ª–µ–≤–∏–∑–æ—Ä', '–§–æ—Ç–æ–∞–ø–ø–∞—Ä–∞—Ç', '–ß–∞—Å—ã', '–ò–≥—Ä–æ–≤–∞—è –∫–æ–Ω—Å–æ–ª—å'];
BEGIN
    FOR i IN 1..p_count LOOP
        INSERT INTO zyryanov_2271.products (
            product_name,
            description,
            price,
            stock_quantity
        ) VALUES (
            products[1 + (i % array_length(products, 1))] || ' ' || 
                (ARRAY['Pro', 'Max', 'Lite', 'Ultra', 'Premium'])[1 + ((i+1) % 5)] || ' ' || i,
            '–í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π ' || products[1 + (i % array_length(products, 1))] || 
                ' –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ' || categories[1 + (i % array_length(categories, 1))],
            (RANDOM() * 100000 + 1000)::NUMERIC(10,2),
            (RANDOM() * 1000)::INTEGER
        );
        
        IF i % 5000 = 0 THEN
            RAISE NOTICE '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: %', i;
        END IF;
    END LOOP;
END;
$BODY$;
ALTER PROCEDURE zyryanov_2271.generate_products_data(integer)
    OWNER TO student;
```
```sql
-- PROCEDURE: zyryanov_2271.generate_orders_data_quick(integer)

-- DROP PROCEDURE IF EXISTS zyryanov_2271.generate_orders_data_quick(integer);

CREATE OR REPLACE PROCEDURE zyryanov_2271.generate_orders_data_quick(
	IN p_count integer DEFAULT 20000)
LANGUAGE 'plpgsql'
AS $BODY$
DECLARE
    client_ids INTEGER[];
    product_ids INTEGER[];
    client_count INTEGER;
    product_count INTEGER;
BEGIN
    RAISE NOTICE '–ù–∞—á–∞–ª–æ –±—ã—Å—Ç—Ä–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤...';
    
    -- –ü–æ–ª—É—á–∞–µ–º ID –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤
    SELECT ARRAY(SELECT client_id FROM zyryanov_2271.clients) INTO client_ids;
    SELECT ARRAY(SELECT product_id FROM zyryanov_2271.products) INTO product_ids;
    
    client_count := array_length(client_ids, 1);
    product_count := array_length(product_ids, 1);
    
    -- –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
    WITH new_orders AS (
        INSERT INTO zyryanov_2271.orders (
            client_id,
            order_date,
            status
        )
        SELECT 
            client_ids[1 + ((seq - 1) % client_count)],
            CURRENT_TIMESTAMP - (random() * 365 * 24 * 60 * 60 * INTERVAL '1 second'),
            (ARRAY['–ù–æ–≤—ã–π', '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω', '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω', '–î–æ—Å—Ç–∞–≤–ª–µ–Ω', '–û—Ç–º–µ–Ω–µ–Ω'])[1 + (seq % 5)]
        FROM generate_series(1, p_count) as seq
        RETURNING order_id
    )
    -- –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–∫–∞–∑–æ–≤ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
    INSERT INTO zyryanov_2271.order_items (
        order_id,
        product_id,
        quantity,
        price_at_time
    )
    SELECT 
        no.order_id,
        product_ids[1 + ((no.order_id + item_num - 1) % product_count)],
        (1 + (floor(random() * 9)::INTEGER) + 1),
        p.price
    FROM new_orders no
    CROSS JOIN generate_series(1, (1 + (floor(random() * 4)::INTEGER))) as item_num
    JOIN zyryanov_2271.products p ON p.product_id = product_ids[1 + ((no.order_id + item_num - 1) % product_count)];
    
    RAISE NOTICE '–ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–æ–∑–¥–∞–Ω–æ –∑–∞–∫–∞–∑–æ–≤: %', p_count;
END;
$BODY$;
ALTER PROCEDURE zyryanov_2271.generate_orders_data_quick(integer)
    OWNER TO student;
```

## –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –≤—ã–ø–æ–ª–µ–Ω–∏—è 
```sql
EXPLAIN (ANALYZE) 
SELECT * FROM zyryanov_2271.clients WHERE email LIKE '%gmail.com%';
```

## —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```sql
-- FUNCTION: zyryanov_2271.create_optimization_indexes()

-- DROP FUNCTION IF EXISTS zyryanov_2271.create_optimization_indexes();

CREATE OR REPLACE FUNCTION zyryanov_2271.create_optimization_indexes(
	)
    RETURNS void
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE PARALLEL UNSAFE
AS $BODY$
BEGIN
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤...';
    
    -- –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏–Ω–¥–µ–∫—Å—ã —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    DROP INDEX IF EXISTS zyryanov_2271.idx_clients_email;
    DROP INDEX IF EXISTS zyryanov_2271.idx_clients_email_pattern;
    DROP INDEX IF EXISTS zyryanov_2271.idx_orders_client_id;
    DROP INDEX IF EXISTS zyryanov_2271.idx_orders_client_id_count;
    
    -- 1. –ë–∞–∑–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    CREATE INDEX idx_clients_email ON zyryanov_2271.clients(email);
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å idx_clients_email';
    
    -- 2. –ò–Ω–¥–µ–∫—Å –¥–ª—è LIKE –ø–æ–∏—Å–∫–∞ (—Ç–æ–ª—å–∫–æ —Å –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏)
    CREATE INDEX idx_clients_email_pattern ON zyryanov_2271.clients(email varchar_pattern_ops);
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å idx_clients_email_pattern';
    
    -- 3. –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è JOIN –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    CREATE INDEX idx_orders_client_id ON zyryanov_2271.orders(client_id);
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å idx_orders_client_id';
    
    -- 4. –ü–æ–∫—Ä—ã–≤–∞—é—â–∏–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
    CREATE INDEX idx_orders_client_id_count ON zyryanov_2271.orders(client_id, order_id);
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å idx_orders_client_id_count';
    
    -- 5. –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –¥–∞—Ç–µ
    CREATE INDEX idx_orders_date ON zyryanov_2271.orders(order_date);
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å idx_orders_date';
    
    -- 6. –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    CREATE INDEX idx_clients_covering ON zyryanov_2271.clients(client_id, email, first_name, last_name);
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å idx_clients_covering';
    
    RAISE NOTICE '–í—Å–µ –∏–Ω–¥–µ–∫—Å—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã!';
END;
$BODY$;

ALTER FUNCTION zyryanov_2271.create_optimization_indexes()
    OWNER TO student;

```